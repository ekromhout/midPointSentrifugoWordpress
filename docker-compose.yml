version: "3.3"

services:
  grouper_daemon:
    build: ./grouper_daemon/
    command: bash -c "while ! curl -s grouper_data:3306 > /dev/null; do echo waiting for mysql on grouper_data to start; sleep 3; done; while ! curl -s ldap://directory:389 > /dev/null; do echo waiting for ldap on directory to start; sleep 3; done; exec daemon"
    depends_on:
     - grouper_data
     - directory
    environment:
     - ENV
     - USERTOKEN
     - GROUPER_CLIENT_WEBSERVICE_PASSWORD_FILE=password
     - GROUPER_DATABASE_PASSWORD_FILE=/run/secrets/g_database_password.txt
     - RABBITMQ_PASSWORD_FILE=/run/secrets/rabbitmq_password.txt
     - SUBJECT_SOURCE_LDAP_PASSWORD=password
    networks:
     - net
    secrets:
     - g_database_password.txt
     - rabbitmq_password.txt
     - source: grouper.hibernate.properties
       target: grouper_grouper.hibernate.properties
     - source: grouper-loader.properties
       target: grouper_grouper-loader.properties
     - source: subject.properties
       target: grouper_subject.properties
    volumes:
     - type: bind
       source: ./configs-and-secrets/grouper/application/grouper.properties
       target: /opt/grouper/conf/grouper.properties
     - type: bind
       source: ./configs-and-secrets/grouper/application/grouper.client.properties
       target: /opt/grouper/conf/grouper.client.properties


  grouper_ui:
    build: ./grouper_ui/
    command: bash -c "while ! curl -s grouper_data:3306 > /dev/null; do echo waiting for mysql on grouper_data to start; sleep 3; done; while ! curl -s ldap://directory:389 > /dev/null; do echo waiting for ldap on directory to start; sleep 3; done; exec ui"
    depends_on:
     - grouper_data
     - directory
    environment:
     - ENV
     - USERTOKEN
     - GROUPER_DATABASE_PASSWORD_FILE=/run/secrets/g_database_password.txt
     - SUBJECT_SOURCE_LDAP_PASSWORD=password
    networks:
     - net
    ports:
     - 4443:443
    secrets:
     - g_database_password.txt
     - source: grouper.hibernate.properties
       target: grouper_grouper.hibernate.properties
     - source: grouper-loader.properties
       target: grouper_grouper-loader.properties
     - source: subject.properties
       target: grouper_subject.properties
     - source: g_sp-key.pem
       target: shib_sp-key.pem
     - source: g_host-key.pem
       target: host-key.pem
    volumes:
     - type: bind
       source: ./configs-and-secrets/grouper/application/grouper.properties
       target: /opt/grouper/conf/grouper.properties
     - type: bind
       source: ./configs-and-secrets/grouper/application/grouper.client.properties
       target: /opt/grouper/conf/grouper.client.properties
     - type: bind
       source: ./configs-and-secrets/grouper/shibboleth/sp-cert.pem
       target: /etc/shibboleth/sp-cert.pem
     - type: bind
       source: ./configs-and-secrets/grouper/shibboleth/shibboleth2.xml
       target: /etc/shibboleth/shibboleth2.xml
     - type: bind
       source: ./configs-and-secrets/grouper/shibboleth/idp-metadata.xml
       target: /etc/shibboleth/idp-metadata.xml
     - type: bind
       source: ./configs-and-secrets/grouper/httpd/host-cert.pem
       target: /etc/pki/tls/certs/host-cert.pem
     - type: bind
       source: ./configs-and-secrets/grouper/httpd/host-cert.pem
       target: /etc/pki/tls/certs/cachain.pem

  sentrifugo_server:
    build: ./sentrifugo_server/
    container_name: sentrifugo_server
    networks:
    -  net
    depends_on:
      - sentrifugo_data
    ports:
      - "8080:80"
    devices:
      - "/dev/tty:/dev/tty"
    links:
      - "sentrifugo_data:sentrifugo_data"

  sentrifugo_data:
    build: ./sentrifugo_data/
    container_name: sentrifugo_data
    networks:
    - net
    volumes:
     - sentrifugo_data:/var/lib/mysql  

  grouper_data:
    build: ./grouper_data/
    networks:
     - net
    ports:
     - 3306:3306
    volumes:
     - grouper_data:/var/lib/mysql  

  directory:
    build: ./directory/
    ports:
     - 389:389
    networks:
     - net
    volumes:
     - ldap:/var/lib/dirsrv

  sources:
    build: ./sources/
    ports:
     - 13306:3306
    networks:
     - net
    volumes:
     - source_data:/var/lib/mysql

  targets:
    build: ./targets/
    ports:
     - 23306:389
    networks:
     - net
    volumes:
     - target_data:/var/lib/mysql

  midpoint_data:
    image: tier/mariadb:mariadb10
    ports:
     - 33306:3306
    networks:
     - net
    volumes:
     - midpoint_mysql:/var/lib/mysql
     - midpoint_data:/var/lib/mysqlmounted
    environment:
     - CREATE_NEW_DATABASE=if_needed

  midpoint_server:
    build: ./midpoint_server/
    depends_on:
     - midpoint_data
    ports:
     - 8443:443
    environment:
     - AUTHENTICATION
     - ENV
     - USERTOKEN
     - REPO_DATABASE_TYPE
     - REPO_JDBC_URL
     - REPO_HOST
     - REPO_PORT
     - REPO_DATABASE
     - REPO_USER
     - REPO_MISSING_SCHEMA_ACTION
     - REPO_UPGRADEABLE_SCHEMA_ACTION
     - REPO_SCHEMA_VERSION_IF_MISSING
     - REPO_SCHEMA_VARIANT
     - MP_MEM_MAX
     - MP_MEM_INIT
     - MP_JAVA_OPTS
     - SSO_HEADER
     - TIER_BEACON_OPT_OUT
     - TIMEZONE
    networks:
     - net
    secrets:
     - mp_database_password.txt
     - mp_keystore_password.txt
     - mp_sp-key.pem
     - mp_host-key.pem
    volumes:
     - midpoint_home:/opt/midpoint/var
     - type: bind
       source: ./configs-and-secrets/midpoint/shibboleth/shibboleth2.xml
       target: /etc/shibboleth/shibboleth2.xml
     - type: bind
       source: ./configs-and-secrets/midpoint/shibboleth/idp-metadata.xml
       target: /etc/shibboleth/idp-metadata.xml
     - type: bind
       source: ./configs-and-secrets/midpoint/shibboleth/sp-cert.pem
       target: /etc/shibboleth/sp-cert.pem
     - type: bind
       source: ./configs-and-secrets/midpoint/httpd/host-cert.pem
       target: /etc/pki/tls/certs/host-cert.pem
     - type: bind
       source: ./configs-and-secrets/midpoint/httpd/host-cert.pem
       target: /etc/pki/tls/certs/cachain.pem

  idp:
    build: ./idp/
    depends_on:
     - directory
    environment:
     - JETTY_MAX_HEAP=64m
     - JETTY_BROWSER_SSL_KEYSTORE_PASSWORD=password
     - JETTY_BACKCHANNEL_SSL_KEYSTORE_PASSWORD=password
    networks:
     - net
    ports:
     - 443:443

  mq:
    build: ./mq/
    environment:
     - RABBITMQ_NODENAME=docker-rabbit
    hostname: rabbitmq
    networks:
     - net
    ports:
     - 15672:15672
    volumes:
     - mq:/var/lib/rabbitmq

  wordpress_server:
    #build: ./wordpress_server/
    image: wordpress
    container_name: wordpress_server
    networks:
    -  net
    depends_on:
      - wordpress_data
    ports:
      - "80:80"
    devices:
      - "/dev/tty:/dev/tty"
    links:
      - "wordpress_data:wordpress_data"
    volumes:
     - wordpress_server:/var/www/html

  wordpress_data:
    build: ./wordpress_data/
    container_name: wordpress_data
    networks:
    - net
    volumes:
     - wordpress_data:/var/lib/mysql  

  wordpress_cli:
    #image: wordpress:cli
    build: ./wordpress_cli/
    links:
      - "wordpress_server:wordpress_server"
    user: xfs
    command: bash -c 'if [ ! -s /var/www/html/wp-config.php ];  then sleep 10; wp config create --dbname=wordpress --dbuser=wordpress --dbpass=54y6RxN7GfC7aes3 --dbhost=wordpress_data; sleep 3; wp core install --url="http://localhost/" --title="wordpress" --admin_user="admin" --admin_password="54y6RxN7GfC7aes3" --admin_email="sentrifugo.container@gmail.com"; sed -i "s/<\/IfModule>/RewriteCond \%{HTTP:Authorization} \^\(\.\*\)\nRewriteRule \^\(\.\*\) - [E=HTTP_AUTHORIZATION:\%1]\n<\/IfModule>\nSetEnvIf Authorization "\(\.\*\)" HTTP_AUTHORIZATION=\$$1/" /var/www/html/.htaccess; /tmp/sed.sh; wp plugin install jwt-authentication-for-wp-rest-api  --activate; fi'
    container_name: wordpress_cli
    networks:
    - net
    depends_on:
      - wordpress_data
      - wordpress_server
    volumes:
     - wordpress_server:/var/www/html

networks:
  net:    
    driver: bridge

secrets:
# grouper
  g_host-key.pem:
    file: ./configs-and-secrets/grouper/httpd/host-key.pem
  g_sp-key.pem:
    file: ./configs-and-secrets/grouper/shibboleth/sp-key.pem
  g_database_password.txt:
    file: ./configs-and-secrets/grouper/application/database_password.txt
  rabbitmq_password.txt:
    file: ./configs-and-secrets/grouper/application/rabbitmq_password.txt
  grouper.hibernate.properties:
    file: ./configs-and-secrets/grouper/application/grouper.hibernate.properties
  grouper-loader.properties:
    file: ./configs-and-secrets/grouper/application/grouper-loader.properties
  subject.properties:
    file: ./configs-and-secrets/grouper/application/subject.properties
# midPoint
  mp_host-key.pem:
    file: ./configs-and-secrets/midpoint/httpd/host-key.pem
  mp_sp-key.pem:
    file: ./configs-and-secrets/midpoint/shibboleth/sp-key.pem
  mp_database_password.txt:
    file: ./configs-and-secrets/midpoint/application/database_password.txt
  mp_keystore_password.txt:
    file: ./configs-and-secrets/midpoint/application/keystore_password.txt    
    
volumes:
  grouper_data:
  source_data:
  target_data:
  ldap:
  midpoint_data:
  midpoint_mysql:
  midpoint_home:
  mq:
  sentrifugo_data:
  wordpress_data:
  wordpress_server:

